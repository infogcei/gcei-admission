<?php
// ============================================
// contact.php - Guru Computer Institute
// Email Processing Script
// ============================================

// Enable error reporting for debugging (remove in production)
error_reporting(E_ALL);
ini_set('display_errors', 1);

// Set timezone
date_default_timezone_set('Asia/Kolkata');

// ===== CONFIGURATION =====
$institute_name = "Guru Computer Education Institute";
$institute_email = "info.gceiofficial@gmail.com";  // Your email
$admin_email = "info.gceiofficial@gmail.com";      // Where to send emails
$website_url = "https://gurucomputerbilha.com";    // Your website URL

// WhatsApp number (for redirection)
$whatsapp_number = "919244240484";

// ===== FUNCTION TO SEND EMAIL =====
function sendEmail($to, $subject, $message, $from_name, $from_email) {
    $headers = "MIME-Version: 1.0" . "\r\n";
    $headers .= "Content-type:text/html;charset=UTF-8" . "\r\n";
    $headers .= "From: $from_name <$from_email>" . "\r\n";
    $headers .= "Reply-To: $from_email" . "\r\n";
    $headers .= "X-Mailer: PHP/" . phpversion();
    
    return mail($to, $subject, $message, $headers);
}

// ===== FUNCTION TO VALIDATE INPUT =====
function validateInput($data) {
    $data = trim($data);
    $data = stripslashes($data);
    $data = htmlspecialchars($data);
    return $data;
}

// ===== FUNCTION TO CREATE WHATSAPP URL =====
function createWhatsAppUrl($data) {
    global $whatsapp_number;
    
    $message = "ğŸ“§ *NEW CONTACT FORM SUBMISSION*\n\n";
    $message .= "ğŸ“› *Name:* " . $data['name'] . "\n";
    $message .= "ğŸ“± *Mobile:* " . $data['mobile'] . "\n";
    $message .= "ğŸ“§ *Email:* " . ($data['email'] ?: 'Not provided') . "\n";
    $message .= "ğŸ“ *Course:* " . ($data['course'] ?: 'Not specified') . "\n";
    $message .= "ğŸ’¬ *Message:* " . ($data['message'] ?: 'No message') . "\n\n";
    $message .= "ğŸ•’ *Time:* " . date('d-M-Y h:i A') . "\n";
    $message .= "ğŸŒ *From Website:* Guru Computer Institute";
    
    $encoded_message = urlencode($message);
    return "https://wa.me/$whatsapp_number?text=$encoded_message";
}

// ===== MAIN PROCESSING =====
if ($_SERVER["REQUEST_METHOD"] == "POST") {
    
    // Collect and validate form data
    $form_data = [
        'name' => validateInput($_POST['name'] ?? ''),
        'mobile' => validateInput($_POST['mobile'] ?? ''),
        'email' => validateInput($_POST['email'] ?? ''),
        'course' => validateInput($_POST['course'] ?? ''),
        'message' => validateInput($_POST['message'] ?? ''),
        'form_type' => validateInput($_POST['form_type'] ?? 'contact'),
        'page_url' => validateInput($_SERVER['HTTP_REFERER'] ?? 'Unknown')
    ];
    
    // Validation checks
    $errors = [];
    
    if (empty($form_data['name'])) {
        $errors[] = "Name is required";
    }
    
    if (empty($form_data['mobile'])) {
        $errors[] = "Mobile number is required";
    } elseif (!preg_match('/^[0-9]{10}$/', $form_data['mobile'])) {
        $errors[] = "Invalid mobile number (10 digits required)";
    }
    
    if (!empty($form_data['email']) && !filter_var($form_data['email'], FILTER_VALIDATE_EMAIL)) {
        $errors[] = "Invalid email address";
    }
    
    // If there are errors
    if (!empty($errors)) {
        $response = [
            'status' => 'error',
            'message' => 'Please fix the following errors:',
            'errors' => $errors
        ];
        
        header('Content-Type: application/json');
        echo json_encode($response);
        exit;
    }
    
    // ===== PREPARE EMAIL CONTENT =====
    
    // Subject based on form type
    if ($form_data['form_type'] == 'admission') {
        $email_subject = "ğŸ“ New Admission Form - Guru Computer Institute";
    } elseif ($form_data['form_type'] == 'demo') {
        $email_subject = "ğŸ“… Demo Class Request - Guru Computer Institute";
    } else {
        $email_subject = "ğŸ“ Contact Form - Guru Computer Institute";
    }
    
    // HTML Email Template
    $email_message = '
    <!DOCTYPE html>
    <html>
    <head>
        <meta charset="UTF-8">
        <style>
            body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
            .container { max-width: 600px; margin: 0 auto; padding: 20px; }
            .header { background: linear-gradient(135deg, #00695c 0%, #004d40 100%); color: white; padding: 20px; border-radius: 10px 10px 0 0; text-align: center; }
            .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
            .info-table { width: 100%; border-collapse: collapse; margin: 20px 0; }
            .info-table td { padding: 10px; border-bottom: 1px solid #ddd; }
            .info-table td:first-child { font-weight: bold; width: 30%; color: #00695c; }
            .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
            .btn { display: inline-block; background: #25D366; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; margin: 10px 0; }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>Guru Computer Education Institute</h1>
                <p>Bilha, Bilaspur (Chhattisgarh)</p>
            </div>
            
            <div class="content">
                <h2>' . ($form_data['form_type'] == 'admission' ? 'ğŸ“ New Admission Request' : 'ğŸ“ Contact Form Submission') . '</h2>
                
                <table class="info-table">
                    <tr>
                        <td>Name:</td>
                        <td>' . htmlspecialchars($form_data['name']) . '</td>
                    </tr>
                    <tr>
                        <td>Mobile:</td>
                        <td>' . htmlspecialchars($form_data['mobile']) . '</td>
                    </tr>';
    
    if (!empty($form_data['email'])) {
        $email_message .= '
                    <tr>
                        <td>Email:</td>
                        <td>' . htmlspecialchars($form_data['email']) . '</td>
                    </tr>';
    }
    
    if (!empty($form_data['course'])) {
        $email_message .= '
                    <tr>
                        <td>Course:</td>
                        <td>' . htmlspecialchars($form_data['course']) . '</td>
                    </tr>';
    }
    
    if (!empty($form_data['message'])) {
        $email_message .= '
                    <tr>
                        <td>Message:</td>
                        <td>' . nl2br(htmlspecialchars($form_data['message'])) . '</td>
                    </tr>';
    }
    
    $email_message .= '
                    <tr>
                        <td>Submission Time:</td>
                        <td>' . date('d-M-Y h:i A') . '</td>
                    </tr>
                    <tr>
                        <td>Form Type:</td>
                        <td>' . ucfirst($form_data['form_type']) . ' Form</td>
                    </tr>
                    <tr>
                        <td>Page URL:</td>
                        <td>' . htmlspecialchars($form_data['page_url']) . '</td>
                    </tr>
                </table>
                
                <div style="margin-top: 30px; padding: 15px; background: #e8f5e9; border-radius: 5px;">
                    <h3 style="color: #00695c; margin-top: 0;">ğŸ“ Quick Contact:</h3>
                    <p><strong>ğŸ“± Call Now:</strong> 92442 40484</p>
                    <p><strong>ğŸ’¬ WhatsApp:</strong> <a href="https://wa.me/919244240484">Click to Chat</a></p>
                    <p><strong>ğŸ“ Address:</strong> Near Police Station, Dagori Road, Bilha, Bilaspur</p>
                </div>
                
                <a href="https://wa.me/919244240484?text=Hi%20Guru%20Computer%20Institute,%20I%20just%20submitted%20the%20form" class="btn">
                    ğŸ’¬ Reply via WhatsApp
                </a>
            </div>
            
            <div class="footer">
                <p>Â© ' . date('Y') . ' Guru Computer Education Institute. All rights reserved.</p>
                <p>This email was generated from the website contact form.</p>
            </div>
        </div>
    </body>
    </html>';
    
    // ===== SEND EMAIL TO ADMIN =====
    $email_sent = sendEmail(
        $admin_email,
        $email_subject,
        $email_message,
        $institute_name,
        $institute_email
    );
    
    // ===== SEND AUTO-REPLY TO USER =====
    if (!empty($form_data['email'])) {
        $user_subject = "Thank You - Guru Computer Institute";
        
        $user_message = '
        <!DOCTYPE html>
        <html>
        <head>
            <meta charset="UTF-8">
            <style>
                body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
                .container { max-width: 600px; margin: 0 auto; padding: 20px; }
                .header { background: linear-gradient(135deg, #00695c 0%, #004d40 100%); color: white; padding: 20px; border-radius: 10px 10px 0 0; text-align: center; }
                .content { background: #f8f9fa; padding: 30px; border-radius: 0 0 10px 10px; }
                .footer { text-align: center; margin-top: 30px; padding-top: 20px; border-top: 1px solid #ddd; color: #666; font-size: 12px; }
                .btn { display: inline-block; background: #25D366; color: white; padding: 12px 25px; text-decoration: none; border-radius: 5px; margin: 15px 0; font-weight: bold; }
                .info-box { background: white; padding: 15px; border-radius: 5px; margin: 15px 0; border-left: 4px solid #00695c; }
            </style>
        </head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>Guru Computer Education Institute</h1>
                    <p>Bilha, Bilaspur (Chhattisgarh) - Since 2015</p>
                </div>
                
                <div class="content">
                    <h2>Thank You for Contacting Us!</h2>
                    
                    <div class="info-box">
                        <p>Dear <strong>' . htmlspecialchars($form_data['name']) . '</strong>,</p>
                        <p>Thank you for your interest in Guru Computer Education Institute. We have received your ' . ($form_data['form_type'] == 'admission' ? 'admission' : 'contact') . ' form and our team will contact you within 24 hours.</p>
                    </div>
                    
                    <h3>ğŸ“ Quick Contact Information:</h3>
                    <ul>
                        <li><strong>ğŸ“± Call:</strong> 92442 40484</li>
                        <li><strong>ğŸ’¬ WhatsApp:</strong> <a href="https://wa.me/919244240484">Click to Chat</a></li>
                        <li><strong>ğŸ“ Address:</strong> Near Police Station, Dagori Road, Bilha, Bilaspur</li>
                        <li><strong>â° Timing:</strong> Monday-Saturday: 9AM-7PM, Sunday: 10AM-4PM</li>
                    </ul>
                    
                    <a href="https://wa.me/919244240484" class="btn">
                        ğŸ’¬ Chat on WhatsApp
                    </a>
                    
                    <div style="margin-top: 25px; padding: 15px; background: #e3f2fd; border-radius: 5px;">
                        <h4 style="color: #1565c0; margin-top: 0;">ğŸ“¢ Special Offer:</h4>
                        <p>ğŸ‰ Get 15% discount on admission this week!</p>
                        <p>ğŸ Free study kit with every enrollment</p>
                    </div>
                </div>
                
                <div class="footer">
                    <p>Â© ' . date('Y') . ' Guru Computer Education Institute. All rights reserved.</p>
                    <p>This is an automated email. Please do not reply to this email.</p>
                </div>
            </div>
        </body>
        </html>';
        
        sendEmail(
            $form_data['email'],
            $user_subject,
            $user_message,
            $institute_name,
            $institute_email
        );
    }
    
    // ===== CREATE WHATSAPP REDIRECT URL =====
    $whatsapp_url = createWhatsAppUrl($form_data);
    
    // ===== PREPARE RESPONSE =====
    $response = [
        'status' => 'success',
        'message' => 'Form submitted successfully!',
        'whatsapp_url' => $whatsapp_url,
        'email_sent' => $email_sent,
        'auto_reply_sent' => !empty($form_data['email']),
        'timestamp' => date('Y-m-d H:i:s')
    ];
    
    // Send JSON response
    header('Content-Type: application/json');
    echo json_encode($response);
    
    exit;
    
} else {
    // If not POST request
    $response = [
        'status' => 'error',
        'message' => 'Invalid request method. Please use POST.'
    ];
    
    header('Content-Type: application/json');
    echo json_encode($response);
    exit;
}
?>
